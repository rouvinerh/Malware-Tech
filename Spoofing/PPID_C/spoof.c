#include <Windows.h>
#include <stdio.h>

#define error(FUNCTIONNAME) printf("[-] %s Failed With Error : %d\n", #FUNCTIONNAME, GetLastError()) // function error
#define log(LOGTEXT) printf("[+] %s\n", #LOGTEXT)
#define generror(ERRTEXT) printf("[-] %s\n", #ERRTEXT) // general error

int main(int argc, char* argv[]) {
	if (argc < 2) {
		printf("Usage: .\\spoof.exe <Parent PID>\n");
		return -1;
	}
	DWORD dwParentId = atoi(argv[1]);
	HANDLE hParent = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwParentId);
	if (!hParent) {
		error(OpenProcess);
		return -1;
	}
	log(Opened Handle);

	// first call to initialise the size of the data structure
	SIZE_T sAttributeCount = NULL;
	InitializeProcThreadAttributeList(NULL, 1, NULL, &sAttributeCount);
	log(First InitializeProcThreadAttributeList);

	STARTUPINFOEXA SiSpoof;
	SiSpoof.StartupInfo.cb = sizeof(STARTUPINFOEXA);
	PROCESS_INFORMATION PiSpoof;
	ZeroMemory(&SiSpoof, sizeof(STARTUPINFOEXA));
	ZeroMemory(&PiSpoof, sizeof(PROCESS_INFORMATION));
	log(Zeroed memory for data structures);

	SiSpoof.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), 0, sAttributeCount);
	InitializeProcThreadAttributeList(SiSpoof.lpAttributeList, 1, NULL, &sAttributeCount);
	log(Second call to populate lpAttributeList);

	if (!UpdateProcThreadAttribute(SiSpoof.lpAttributeList, NULL, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hParent, sizeof(HANDLE), NULL, NULL)) {
		error(UpdateProcThreadAttribute);
		return -1;
	}
	log(Updated thread attribute);

	CHAR lpPath[MAX_PATH] = "C:\\Windows\\System32";
	
	if (!CreateProcessA(NULL, (LPSTR)"notepad", NULL, NULL, FALSE, EXTENDED_STARTUPINFO_PRESENT, NULL, lpPath, &SiSpoof.StartupInfo, &PiSpoof)) {
		error(CreateProcessA);
		return -1;
	}
	log(Spawned process!);
}